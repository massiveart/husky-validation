<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>js/mapper.js - husky-validation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="husky-validation"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Collection.html">Collection</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: js/mapper.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * This file is part of the Husky Validation.
 *
 * (c) MASSIVE ART WebServices GmbH
 *
 * This source file is subject to the MIT license that is bundled
 * with this source code in the file LICENSE.
 *
 */

// TODO yui doc

define([
    &#x27;form/util&#x27;
], function(Util) {

    &#x27;use strict&#x27;;

    return function(form) {

        var filters = {},

        // private functions
            that = {
                initialize: function() {
                    Util.debug(&#x27;INIT Mapper&#x27;);

                    this.collections = [];
                    this.collectionsSet = {};
                    this.emptyTemplates = {};
                    this.templates = {};
                    this.elements = [];
                },

                addEmptyTemplate: function($element, propertyName) {
                    if (this.emptyTemplates.hasOwnProperty(propertyName)) {
                        var $emptyTemplate = $(this.emptyTemplates[propertyName].tpl);
                        $emptyTemplate.attr(&#x27;id&#x27;, this.emptyTemplates[propertyName].id);
                        $element.append($emptyTemplate);
                    }
                },

                processData: function(el, propertyName, returnMapperId) {
                    // get attributes
                    var $el = $(el),
                        element = $el.data(&#x27;element&#x27;),
                        filterAction = filters[propertyName],
                        value = element.getValue(propertyName, returnMapperId),
                        result = [],
                        i, len;

                    // filter result
                    if (!!filterAction) {
                        if ($.isArray(value)) {
                            for (i = 0, len = value.length; i &lt; len; i++) {
                                if (filterAction(value[i])) {
                                    result.push(value[i]);
                                }
                            }
                        } else {
                            if (filterAction(value)) {
                                result = value;
                            } else {
                                result = null;
                            }
                        }
                    } else {
                        result = value;
                    }

                    return result;
                },

                /**
                 * Returns a collection element for a given mapper-id
                 * @param {number} mapperId
                 * @return {Object|null} the dom object or null
                 **/
                getElementByMapperId: function(mapperId) {
                    for (var i = -1, length = this.elements.length; ++i &lt; length;) {
                        if (this.elements[i].data(&#x27;mapper-id&#x27;) === mapperId) {
                            return this.elements[i];
                        }
                    }
                    return null;
                },

                /**
                 * Delets an element from the DOM and the global object by a given unique-id
                 * @param {number} mapperId
                 * @return {boolean|string} if an element was found and deleted it returns its template-name, else it returns false
                 **/
                deleteElementByMapperId: function(mapperId) {
                    var i, length, templateName;
                    for (i = -1, length = this.elements.length; ++i &lt; length;) {
                        if (this.elements[i].data(&#x27;mapper-id&#x27;).toString() === mapperId.toString()) {
                            templateName = this.elements[i].attr(&#x27;data-mapper-property-tpl&#x27;);
                            this.elements[i].remove();
                            this.elements.splice(i, 1);
                            return templateName;
                        }
                    }
                    return false;
                },

                getData: function($el, returnMapperId) {
                    if (!$el) {
                        $el = form.$el;
                    }
                    // fix dom node bug
                    $el = $($el);

                    var data = {}, $childElement, properties, parts, i, len, property,

                    // search field with mapper property
                        selector = &#x27;*[data-mapper-property]&#x27;,
                        $elements = $el.find(selector);

                    // do it while elements exists
                    while ($elements.length &gt; 0) {
                        // get first
                        $childElement = $($elements.get(0));
                        properties = $childElement.data(&#x27;mapperProperty&#x27;).split(&#x27;,&#x27;);

                        for (i = 0, len = properties.length; i &lt; len; i++) {
                            property = properties[i];

                            if (property.match(/.*\..*/)) {
                                parts = property.split(&#x27;.&#x27;);
                                data[parts[0]] = {};
                                data[parts[0]][parts[1]] = that.processData.call(this, $childElement, parts[0], returnMapperId);
                            } else {
                                data[property] = that.processData.call(this, $childElement, property, returnMapperId);
                            }
                        }

                        // remove element itself
                        $elements = $elements.not($childElement);

                        // remove child elements
                        $elements = $elements.not($childElement.find(selector));
                    }

                    return data;
                },

                setData: function(data, $el) {
                    if (!$el) {
                        $el = form.$el;
                    }

                    var dfd = $.Deferred(),
                        selector,
                        $element,
                        element,
                        count = 1,
                        resolve = function() {
                            count--;
                            if (count === 0) {
                                dfd.resolve();
                            }
                        };

                    if (typeof data !== &#x27;object&#x27;) {
                        selector = &#x27;*[data-mapper-property]&#x27;;
                        $element = $el.find(selector);
                        element = $element.data(&#x27;element&#x27;);
                        // if element is not in form add it
                        if (!element) {
                            element = form.addField($element);
                            element.initialized.then(function() {
                                element.setValue(data, &#x27;TODO&#x27;).then(function() {
                                    // resolve this set data
                                    resolve();
                                });
                            }.bind(this));
                        } else {
                            element.setValue(data, &#x27;TODO&#x27;).then(function() {
                                // resolve this set data
                                resolve();
                            });
                        }
                    } else if (data !== null &amp;&amp; !$.isEmptyObject(data)) {
                        count = Object.keys(data).length;
                        $.each(data, function(key, value) {
                            var $element, element;

                            // search field with mapper property
                            selector = &#x27;*[data-mapper-property*=&quot;&#x27; + key + &#x27;&quot;]&#x27;;
                            $element = $el.andSelf().find(selector);

                            element = $element.data(&#x27;element&#x27;);

                            if ($element.length &gt; 0) {
                                // if element is not in form add it
                                if (!element) {
                                    element = form.addField($element);
                                    element.initialized.then(function() {
                                        element.setValue(value, key).then(function() {
                                            resolve();
                                        });
                                    }.bind(this));
                                } else {
                                    element.setValue(value, key).then(function() {
                                        resolve();
                                    });
                                }
                            } else {
                                resolve();
                            }
                        }.bind(this));
                    } else {
                        dfd.resolve();
                    }

                    return dfd.promise();
                }

            },

        // define mapper interface
            result = {

                setData: function(data, $el) {
                    this.collectionsSet = {};

                    return that.setData.call(this, data, $el);
                },

                /**
                 * extracts data from $element or default form element
                 *  @param {Object} [$el=undefined] element to select data from
                 *  @param {Boolean} [returnMapperId=false] returnMapperId
                 */
                getData: function($el, returnMapperId) {
                    return that.getData.call(this, $el, returnMapperId);
                },

                addCollectionFilter: function(name, callback) {
                    filters[name] = callback;
                },

                removeCollectionFilter: function(name) {
                    delete filters[name];
                },

                /**
                 * adds an element to a existing collection
                 * @param {String} propertyName property defined by &#x27;data&#x27; attribute in data-mapper-property
                 * @param {Object} [data] Possibility to set data
                 * @param {Boolean} [append=false] Define if element should be added at the end of the collection. By default items are grouped by tpl name
                 */
                addToCollection: function(propertyName, data, append) {
                    var template = this.templates[propertyName],
                        element = template.collection.$element,
                        insertAfterLast = false,
                        lastElement,
                        $emptyTpl,
                        dfd = $.Deferred();

                    // check if element exists and put it after last
                    if (!append &amp;&amp; (lastElement = element.find(&#x27;*[data-mapper-property-tpl=&quot;&#x27; + template.tpl.id + &#x27;&quot;]&#x27;).last()).length &gt; 0) {
                        element = lastElement;
                        insertAfterLast = true;
                    }
                    // check if empty template is set and lookup in dom
                    if (template.emptyTemplate) {
                        $emptyTpl = $(element).find(&#x27;#&#x27; + template.emptyTemplate);
                        if ($emptyTpl) {
                            $emptyTpl.remove();
                        }
                    }

                    that.appendChildren.call(this, element, template.tpl, data, data, insertAfterLast).then(function($element) {
                        dfd.resolve($element);
                    }.bind(this));

                    return dfd;
                },

                /**
                 * Edits a field in an collection
                 * @param mapperId {Number} the unique Id of the field
                 * @param data {Object} new data to apply
                 */
                editInCollection: function(mapperId, data) {
                    var $element = that.getElementByMapperId.call(this, mapperId);
                    that.setData.call(this, data, $element);
                },

                /**
                 * Removes a field from a collection
                 * @param mapperId {Number} the unique Id of the field
                 */
                removeFromCollection: function(mapperId) {
                    var i,
                        templateName = that.deleteElementByMapperId.call(this, mapperId);

                    // check if collection still has elements with propertyName, else render empty Template
                    if (form.$el.find(&#x27;*[data-mapper-property-tpl=&#x27; + templateName + &#x27;]&#x27;).length &lt; 1) {
                        // get collection with is owner of templateName
                        for (i in this.templates) {
                            // if emptyTemplates is set
                            if (this.templates[i].tpl.id === templateName) {
                                that.addEmptyTemplate.call(this, this.templates[i].collection.$element, i);
                                return;
                            }
                        }
                    }

                }
            };

        that.initialize.call(result);
        return result;
    };

});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
